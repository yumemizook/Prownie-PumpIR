<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>-- ACCOUNT DELETION PENDING --</title>
    <link rel="stylesheet" href="./styles/home.css" />
    <link rel="shortcut icon" type="image/x-icon" href="./img/brownie.ico" />
    <style>
        .goodbye {
            text-align: center;
            margin-top: 100px;
        }
        .goodbye2 {
            text-align: center;
            margin-bottom: 100px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #111;
            color: #fff;
            padding: 20px;
        }
        .timertext {
            text-align: center;
            margin-bottom: 20px;
        }
        .timerwrapper {
            text-align: center;
            margin-top: 100px;
        }
        .timerdisplay {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 20px;
            gap: 10px;
        }
        .timer {
            font-size: 140px;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 0;
            display: flex;
            align-items: flex-end;
        }
        .timerms {
            font-size: 70px;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 18px;
            display: flex;
            align-items: flex-end;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div class="goodbye" id="goodbye">
        <h3>Account deletion pending...</h3>
        <h4>It's not too late to salvage your account! Click out of this page to cancel deletion!</h4>
    </div>
    <div class="timerwrapper">
        <div class="timertext">Account deletion in</div>
        <div class="timerdisplay">
            <div class="timer" id="timer">
                15
            </div>
            <div class="timerms" id="timerms">
                .00
            </div>
        </div>
    </div>
    <div class="goodbye2" id="goodbye2">
        <h4>It's not too late to salvage your account! Click out of this page to cancel deletion!</h4>
        <h3>Account deletion pending...</h3>
    </div>
    <script type="module">
    import { getAuth, onAuthStateChanged, deleteUser, deleteDoc, doc, getFirestore, collection, getDocs } from "./torture/firebase.js";
    const auth = getAuth();
    const db = getFirestore();
    const urlParams = new URLSearchParams(window.location.search);
    const uidURL = urlParams.get("uid");

  document.addEventListener("DOMContentLoaded", () => {
        // Wait for auth state to be ready before accessing currentUser
        onAuthStateChanged(auth, (user) => {
            const uid = user.uid;
            console.log(uid, uidURL);
            if (uid !== uidURL) {
                alert("You are not the user you are trying to delete. What are you doing here?");
                window.location.href = "/index.html";
                return;
            }
        });
    });

        let timeLeft = 15000; // ms
        const timerElem = document.getElementById("timer");
        const timermsElem = document.getElementById("timerms");

        function updateTimerDisplay(ms) {
            const seconds = Math.floor(ms / 1000);
            const msRemainder = ms % 1000;
            timerElem.textContent = seconds;
            timermsElem.textContent = "." + msRemainder.toString().padStart(3, "0").slice(0, 2);
        }

        updateTimerDisplay(timeLeft);

        // Make interval accessible for clearing in deleteAccount
        window.__accountDeletionInterval = setInterval(() => {
            timeLeft -= 10;
            if (timeLeft > 0) {
                updateTimerDisplay(timeLeft);
            } else {
                clearInterval(window.__accountDeletionInterval);
                timerElem.textContent = "0";
                timermsElem.textContent = ".00";
                // Proceed with account deletion
                onAuthStateChanged(auth, async (user) => {
                    await deleteAccount(user);
                });
            }
        }, 10);

        // If user leaves the page, cancel deletion (handled by not deleting if not present)

    async function deleteAccount(user) {
        try {
            // Ensure user and uid are valid
            if (!user || !user.uid) {
                throw new Error("Invalid user.");
            }
            const uid = user.uid;

            // Delete all documents in the scores subcollection
            const scoresColRef = collection(db, "users", uid, "scores");
            const scoresSnap = await getDocs(scoresColRef);
            const deleteScorePromises = [];
            scoresSnap.forEach((scoreDoc) => {
                deleteScorePromises.push(deleteDoc(scoreDoc.ref));
            });
            await Promise.all(deleteScorePromises);

            // Delete the user document from Firestore
            const userDocRef = doc(db, "users", uid);
            await deleteDoc(userDocRef);

            // Delete the user from Firebase Auth
            await deleteUser(user);

            // Update UI to reflect deletion
            const timerElem = document.getElementById("timer");
            if (timerElem) timerElem.textContent = "";
            const timermsElem = document.getElementById("timerms");
            if (timermsElem) timermsElem.textContent = "";
            const goodbyeElem = document.getElementById("goodbye");
            if (goodbyeElem) goodbyeElem.innerHTML = "<h3>Your account has been deleted.</h3><h4>We are sorry to see you go.</h4>";
            const goodbye2Elem = document.getElementById("goodbye2");
            if (goodbye2Elem) goodbye2Elem.innerHTML = "<h4>We are sorry to see you go.</h4><h3>Your account has been deleted.</h3>";
            const timerwrapperElem = document.getElementById("timertext");
            if (timerwrapperElem) timerwrapperElem.innerHTML = "";
            if (window.__accountDeletionInterval) {
                clearInterval(window.__accountDeletionInterval);
                window.__accountDeletionInterval = undefined;
            }
        } catch (err) {
            if (err?.code === "auth/requires-recent-login") {
                alert("Please re-login to confirm account deletion.");
                window.location.href = "/index.html";
            }
        }
    }
    </script>
</body>
</html>